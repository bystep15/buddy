/*!
 * Bootstrap Grunt task for the CommonJS module generation
 * http://getbootstrap.com
 * Copyright 2014-2015 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 */

'use strict';

var fs = require('fs');
var path = require('path');

var COMMONJS_BANNER = '// This file is autogenerated via the `commonjs` Grunt task. You can require() this file in a CommonJS environment.\n';
var SEAJS_HEADER = ';define(function (require, exports, module) {\n';
var SEAJS_FOOTER = '\n});';

module.exports = function generateCommonJSModule(grunt, srcFiles, destDir) {

    destDir = path.normalize(destDir);

    destDir.split(path.sep).reduce(function (dir, segment) {
        dir = path.join(dir, segment);

        try {
            fs.statSync(dir);
        } catch (ex) {
            fs.mkdirSync(dir);
        }

        return dir;
    }, '');

    function srcPathToDestRequire(srcFilepath) {
        var source = SEAJS_HEADER + fs.readFileSync(srcFilepath, 'utf-8') + SEAJS_FOOTER;
        var fileName = path.basename(srcFilepath);
        var destFilepath = path.join(destDir, fileName);
        fs.writeFileSync(destFilepath, source);
        grunt.log.writeln('File ' + destFilepath.cyan + ' created.');
    }

    try {
        srcFiles.forEach(srcPathToDestRequire);
    } catch (err) {
        grunt.fail.warn(err);
    }
};
